ğŸ§° PRÃ‰REQUIS (LiveCD CachyOS)

ğŸ” VÃ©rifier que ZFS est dispo 
$ sudo -i
$ modprobe zfs
$ zfs version

ğŸ§ª CAS 1 â€” ROLLBACK SNAPSHOT LOCAL (le plus simple)
ğŸ‘‰ Utilisez ce cas si mon pool interne zpcachyos est intact
âœ Rollback via snapshot LOCAL (le plus rapide)
ğŸ¯ Cas typiques
pacman a cassÃ© le systÃ¨me
boot KO
service critique HS
kernel / initramfs brisÃ©

â¡ï¸ Le SSD est toujours lisible

ğŸ§­ Ã‰tapes (depuis le systÃ¨me ou un LiveCD)
1ï¸âƒ£ DÃ©marrer sur LiveCD CachyOS

1ï¸âƒ£ Importer le pool systÃ¨me
$ zpool import

# On devrait voir zpcachyos

2ï¸âƒ£ Importer le pool systÃ¨me

$ zpool import -N zpcachyos

2ï¸âƒ£ VÃ©rifier les datasets
$ zfs list

# zpcachyos/ROOT/cos
# zpcachyos/home
# zpcachyos/varcache

3ï¸âƒ£ Lister les snapshots disponibles

$ zfs list -t snapshot -r zpcachyos/ROOT/cos

zpcachyos/ROOT/cos@auto-2025-12-17_17-06
zpcachyos/ROOT/cos@auto-2025-12-17_17-03
zpcachyos/ROOT/cos@auto-2025-12-17_17-01
zpcachyos/ROOT/cos@auto-2025-12-17_16-57

4ï¸âƒ£ âš ï¸ ROLLBACK (IRRÃ‰VERSIBLE)

sudo zfs rollback -r zpcachyos/ROOT/cos@auto-2025-12-17_17-03

âœ” remet /, /home, /var/* exactement comme Ã  cette date
âŒ supprime les changements plus rÃ©cents

5ï¸âƒ£ Rebooter
reboot

â¡ï¸ SystÃ¨me restaurÃ© en quelques secondes

ğŸŸ  SCÃ‰NARIO 2 â€” FORCE MAJEURE
âœ Restauration COMPLETE depuis HDD USB (LiveCD)
ğŸ¯ Cas typiques

SSD mort
pool zpcachyos corrompu
disque remplacÃ©
machine qui ne boote plus du tout

ğŸ§­ Ã‰tapes COMPLÃˆTES (LiveCD CachyOS)
0ï¸âƒ£ PrÃ©-requis
Nouveau SSD installÃ©
HDD USB branchÃ© (backuppool)
LiveCD CachyOS

$ sudo -i

1ï¸âƒ£ Identifier le disque
$ lsblk 

nvme0n1   476G

2ï¸âƒ£ CrÃ©er la table GPT + partitions

sgdisk --zap-all /dev/nvme0n1
sgdisk \
  -n1:1M:+2G   -t1:EF00 -c1:"EFI" \
  -n2:0:0      -t2:BF00 -c2:"ZFS" \
  /dev/nvme0n1

ğŸ‘‰ RÃ©sultat :
/dev/nvme0n1p1 â†’ EFI (/boot)
/dev/nvme0n1p2 â†’ ZFS

3ï¸âƒ£ CrÃ©er /boot (FAT32)
$ mkfs.fat -F32 /dev/nvme0n1p1

ğŸŸ  Ã‰TAPE 2 â€” CrÃ©er le pool ZFS
$ zpool create -f -o ashift=12 \
  -O compression=zstd \
  -O atime=off \
  zpcachyos /dev/nvme0n1p2

=== CrÃ©er la structure minimale : ===
$ zfs create zpcachyos/ROOT
$ zfs create zpcachyos/ROOT/cos

ğŸŸ  Ã‰TAPE 3 â€” Restaurer depuis le HDD USB

$ zpool import -N -o readonly=on zpbackup

=== Choisir le snapshot Ã  restaurer ===
$ zfs list -t snapshot -r zpbackup/cachyos_backup

zpbackup/cachyos_backup@auto-2025-12-16_23-48              0B      -    96K  -
zpbackup/cachyos_backup@auto-2025-12-16_23-57              0B      -    96K  -
zpbackup/cachyos_backup@auto-2025-12-17_00-25              0B      -    96K  -
zpbackup/cachyos_backup@auto-2025-12-17_00-26              0B      -    96K  -
zpbackup/cachyos_backup@auto-2025-12-17_16-57              0B      -    96K  -
zpbackup/cachyos_backup@auto-2025-12-17_17-01              0B      -    96K  -
zpbackup/cachyos_backup@auto-2025-12-17_17-03              0B      -    96K  -
zpbackup/cachyos_backup@auto-2025-12-17_17-06              0B      -    96K  -

$ zfs send -R zpbackup/cachyos_backup@auto-YYYY-MM-DD_HH-MM \
  | zfs receive -F -u zpcachyos/ROOT

ğŸŸ  Ã‰TAPE 4 â€” Fixer les mountpoints

$ zfs set mountpoint=/ zpcachyos/ROOT/cos/root
$ zfs set mountpoint=/home zpcachyos/ROOT/cos/home
$ zfs set mountpoint=/var/cache zpcachyos/ROOT/cos/varcache
$ zfs set mountpoint=/var/log zpcachyos/ROOT/cos/varlog

ğŸŸ  Ã‰TAPE 5 â€” Monter /boot (CRITIQUE)

$ mkdir -p /mnt
$ zfs mount zpcachyos/ROOT/cos/root

$ mkdir -p /mnt/boot
$ mount /dev/nvme0n1p1 /mnt/boot

ğŸŸ  Ã‰TAPE 6 â€” Chroot
$ mount --rbind /dev  /mnt/dev
$ mount --rbind /proc /mnt/proc
$ mount --rbind /sys  /mnt/sys
$ chroot /mnt

ğŸŸ  Ã‰TAPE 7 â€” Bootloader
$ bootctl install
$ mkinitcpio -P
$ ls /boot
$ ls /boot/loader/entries

ğŸŸ  Ã‰TAPE 8 â€” Reboot
$ exit
$ reboot


ğŸ§  POINTS CRITIQUES Ã€ RETENIR
âœ” Le rollback local est instantanÃ©
âœ” Le send inverse est fiable mÃªme aprÃ¨s des mois
âœ” LiveCD suffit, pas besoin du systÃ¨me installÃ©
âœ” Aucun rsync systÃ¨me
âœ” Aucun montage automatique dangereux

ğŸŸ¢ RÃ‰SUMÃ‰ ULTRA-COURT
ProblÃ¨me logiciel â†’ rollback snapshot local
SSD mort          â†’ zfs send depuis HDD USB
USB occasionnel   â†’ aucun souci


                ğŸ’¥ PROBLÃˆME SYSTÃˆME ğŸ’¥
                        |
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        |                               |
  SSD LISIBLE ?                    SSD MORT ?
        |                               |
       OUI                             NON
        |                               |
        v                               v
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ SNAPSHOT LOCAL â”‚           â”‚ BACKUP HDD USB ZFS â”‚
â”‚ zpcachyos      â”‚           â”‚ zpbackup           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        |                               |
        v                               v
zfs rollback -r              zfs send | zfs receive
zpcachyos/ROOT/cos@auto-*    zpbackup   â†’ zpcachyos
        |                               |
        v                               v
     reboot                       bootloader + reboot

â± Minutes                         â± 10â€“20 min

