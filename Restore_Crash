ğŸ§° PRÃ‰REQUIS (LiveCD CachyOS)

ğŸ” VÃ©rifier que ZFS est dispo 
$ sudo -i
$ modprobe zfs
$ zfs version

ğŸ§ª CAS 1 â€” ROLLBACK SNAPSHOT LOCAL (le plus simple)
ğŸ‘‰ Utilisez ce cas si mon pool interne zpcachyos est intact
âœ Rollback via snapshot LOCAL (le plus rapide)
ğŸ¯ Cas typiques
pacman a cassÃ© le systÃ¨me
boot KO
service critique HS
kernel / initramfs brisÃ©

â¡ï¸ Le SSD est toujours lisible

ğŸ§­ Ã‰tapes (depuis le systÃ¨me ou un LiveCD)
1ï¸âƒ£ DÃ©marrer sur LiveCD CachyOS

1ï¸âƒ£ Importer le pool systÃ¨me
$ zpool import

# On devrait voir zpcachyos

2ï¸âƒ£ Importer le pool systÃ¨me

$ zpool import -N zpcachyos

2ï¸âƒ£ VÃ©rifier les datasets
$ zfs list

# zpcachyos/ROOT/cos
# zpcachyos/home
# zpcachyos/varcache

3ï¸âƒ£ Lister les snapshots disponibles

$ zfs list -t snapshot -r zpcachyos/ROOT/cos

zpcachyos/ROOT/cos@auto-2025-12-17_17-06
zpcachyos/ROOT/cos@auto-2025-12-17_17-03
zpcachyos/ROOT/cos@auto-2025-12-17_17-01
zpcachyos/ROOT/cos@auto-2025-12-17_16-57

4ï¸âƒ£ âš ï¸ ROLLBACK (IRRÃ‰VERSIBLE)

sudo zfs rollback -r zpcachyos/ROOT/cos@auto-2025-12-17_17-03

âœ” remet /, /home, /var/* exactement comme Ã  cette date
âŒ supprime les changements plus rÃ©cents

5ï¸âƒ£ Rebooter
reboot

â¡ï¸ SystÃ¨me restaurÃ© en quelques secondes

ğŸŸ  SCÃ‰NARIO 2 â€” FORCE MAJEURE
âœ Restauration COMPLETE depuis HDD USB (LiveCD)
ğŸ¯ Cas typiques

SSD mort
pool zpcachyos corrompu
disque remplacÃ©
machine qui ne boote plus du tout

ğŸ§­ Ã‰tapes COMPLÃˆTES (LiveCD CachyOS)
0ï¸âƒ£ PrÃ©-requis

Nouveau SSD installÃ©
HDD USB branchÃ© (backuppool)
LiveCD CachyOS

1ï¸âƒ£ CrÃ©er le pool sur le nouveau SSD
$ lsblk 
â¯ lsblk
NAME        MAJ:MIN RM   SIZE RO TYPE MOUNTPOINTS
sda           8:0    0 238,5G  0 disk 
â”œâ”€sda1        8:1    0     2G  0 part /boot
â””â”€sda2        8:2    0 236,5G  0 part 
zram0       253:0    0   7,1G  0 disk [SWAP]
nvme0n1     259:0    0 476,9G  0 disk 
â”œâ”€nvme0n1p1 259:1    0   100M  0 part 
â”œâ”€nvme0n1p2 259:2    0    16M  0 part 
â”œâ”€nvme0n1p3 259:3    0 476,1G  0 part 
â””â”€nvme0n1p4 259:4    0   744M  0 part 

$ sudo -i
$ zpool create -f -o ashift=12 \
  -O compression=zstd \
  -O atime=off \
  zpcachyos /dev/nvme0n1p3

=== CrÃ©er la structure minimale : ===
$ zfs create zpcachyos/ROOT
$ zfs create zpcachyos/ROOT/cos

2ï¸âƒ£ Importer le disque USB (readonly)
$ zpool import -N -o readonly=on backuppool

3ï¸âƒ£ Choisir le snapshot Ã  restaurer
$ zfs list -t snapshot -r backuppool/cachyos_backup

backuppool/cachyos_backup@auto-2025-12-16_23-48              0B      -    96K  -
backuppool/cachyos_backup@auto-2025-12-16_23-57              0B      -    96K  -
backuppool/cachyos_backup@auto-2025-12-17_00-25              0B      -    96K  -
backuppool/cachyos_backup@auto-2025-12-17_00-26              0B      -    96K  -
backuppool/cachyos_backup@auto-2025-12-17_16-57              0B      -    96K  -
backuppool/cachyos_backup@auto-2025-12-17_17-01              0B      -    96K  -
backuppool/cachyos_backup@auto-2025-12-17_17-03              0B      -    96K  -
backuppool/cachyos_backup@auto-2025-12-17_17-06              0B      -    96K  -

$ zfs send -R backuppool/cachyos_backup@auto-2025-12-17_17-06 \
  | zfs receive -F -u zpcachyos/ROOT

âœ” restaure :
/
/home
/var/cache
/var/log
propriÃ©tÃ©s ZFS
sous-datasets

5ï¸âƒ£ Fixer les mountpoints
$ zfs set mountpoint=/ zpcachyos/ROOT/cos/root
$ zfs set mountpoint=/home zpcachyos/ROOT/cos/home
$ zfs set mountpoint=/var/cache zpcachyos/ROOT/cos/varcache
$ zfs set mountpoint=/var/log zpcachyos/ROOT/cos/varlog

6ï¸âƒ£ Monter et chroot
$ mkdir -p /mnt
$ zfs mount zpcachyos/ROOT/cos/root
$ mount --make-rslave /mnt
$ zfs mount -a
$ mount --rbind /dev /mnt/dev
$ mount --rbind /proc /mnt/proc
$ mount --rbind /sys /mnt/sys
$ chroot /mnt

7ï¸âƒ£ RÃ©installer le bootloader
$ bootctl install
$ mkinitcpio -P

8ï¸âƒ£ Rebooter
$ exit
$ reboot

ğŸ§  POINTS CRITIQUES Ã€ RETENIR
âœ” Le rollback local est instantanÃ©
âœ” Le send inverse est fiable mÃªme aprÃ¨s des mois
âœ” LiveCD suffit, pas besoin du systÃ¨me installÃ©
âœ” Aucun rsync systÃ¨me
âœ” Aucun montage automatique dangereux

ğŸŸ¢ RÃ‰SUMÃ‰ ULTRA-COURT
ProblÃ¨me logiciel â†’ rollback snapshot local
SSD mort          â†’ zfs send depuis HDD USB
USB occasionnel   â†’ aucun souci


                ğŸ’¥ PROBLÃˆME SYSTÃˆME ğŸ’¥
                        |
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        |                               |
  SSD LISIBLE ?                    SSD MORT ?
        |                               |
       OUI                             NON
        |                               |
        v                               v
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ SNAPSHOT LOCAL â”‚           â”‚ BACKUP HDD USB ZFS â”‚
â”‚ zpcachyos     â”‚           â”‚ backuppool          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        |                               |
        v                               v
zfs rollback -r              zfs send | zfs receive
zpcachyos/ROOT/cos@auto-*    backuppool â†’ zpcachyos
        |                               |
        v                               v
     reboot                       bootloader + reboot

â± Minutes                         â± 10â€“20 min

